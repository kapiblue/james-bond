---
title: "WHAT MAKES A GREAT JAMES BOND MOVIE?"
author: "Kacper Dobek"
date: "2022-08-08"
output: 
    html_document:
        css: "resources/style.css"
        code_folding: hide
        code_download: true
        toc: true
        out_width: 80%
        
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
library(HoRM)
library(dplyr)
library(knitr)
library(DALEX)
library(caret)
library(ggplot2)
library(corrplot)
library(plotly)
set.seed(007)
```

## Introduction

> Whether this is a great number or peculiar gadgets or glasses of cold vodka Martni, there are definitely many aspects constituting a great James Bond movie. Having watched *A spy who loved me (1977)* recently I've begun to wonder if that could be somehow assessed by the help of machine learning. This is my small summer data science project that aims to predict the average IMDB score for the newest 007 movie *No time to die* and see what contributes to the score.

> More formally, we will be looking at a regression problem for a small dataset (24 items) and training a random forest using cross validation. Then we will examine the breakdown plot for a previously unseen example - the new movie. I will be using *caret* package for the model and *DALEX* for explanation.

## 1. The data: For your eyes only

```{r dataprep}
data(JamesBond)
df <- JamesBond %>% select(-US_Gross, -World_Gross, -US_Adj, -Budget, -Avg_User_Rtn_Tom) %>%
  relocate(Avg_User_IMDB, .after = last_col())
```

I will be using the James Bond dataset from the HoRM package. [See resources](#Resources)\
Here we have the data of the previous 24 movies. I'm going to use 12 ouf of the 18 available features, namely: `r colnames(df)`.\
To clear out the feature names:\
- **World_Adj** The film's 2013-adjusted worldwide gross (in 1000's of U.S. dollars).\
- **Budget_Adj** The film's 2013-adjusted budget (in 1000's of U.S. dollars).\
- **Avg_User_IMDB** The average user rating on IMDB (www.imdb.com).\
- **Conquests** The number of "conquests" by Bond in the film.\
- **Martinis** The number of martinis Bond drank in the film.\
- **BJB** The number of times Bond stated "Bond. James Bond." in the movie.\
- **Kills_Bond** The number of people killed by Bond.\
- **Kills_Others** The number of people killed in the film by people other than Bond.\
- **Top_100** An indicator where a value of 1 means the title song within the top 100 on the UK Singles Chart and the U.S. Billboard Hot 100 and a value of 0 means it did not.\



```{r table, fig.width = 12}
kable(df)
```

## 2. Stats: Live and let die


```{r martinis, fig.width= 14, fig.height= 7}
plot_df <- JamesBond
plot_df$Movie <- factor (plot_df$Movie , levels = plot_df$Movie) # we want to preserve the dataframe's chronological movieordering

m <- list(
  l = 100,
  r = 50,
  b = 80,
  t = 150,
  pad = 2
)

fig <- plot_ly(plot_df, x = ~Year, y = ~Martinis, type= 'scatter', mode= 'lines+markers',
               line = list(color = 'rgba(49,130,189, 1)', width = 4),
               marker = list(color = 'rgba(49,130,189, 1)', size = 12),
               hoverinfo = 'text',
               text = ~paste(Movie, Year)) %>%
  layout(title = "The number of Martini drinks Bond consumed in the movie",
         font=list(size = 20),
         margin = m,
         xaxis = list(
           showgrid = FALSE,
           zeroline = FALSE,
           tickfont = list(size = 16)
         ),
         yaxis = list(
           showgrid = FALSE,
           zeroline = TRUE 
         ))
fig
```
Look at another chart: 

```{r kills, fig.width= 14, fig.height= 8}

fig <- plot_ly(plot_df, x = ~Year, y = ~Kills_Bond, name = 'Kills Bond', type= 'scatter', mode= 'lines+markers',
               line = list(color = 'rgba(49,130,189, 1)', width = 4),
               marker = list(color = 'rgba(49,130,189, 1)', size = 12),
               hoverinfo = 'text',
               text = ~paste(Movie, Year)) %>%
  add_trace(y = ~Kills_Others,  type = 'scatter', mode= 'lines+markers',
               name = "Kills Others",
               line = list(color = 'rgba(49,45,129, 1)', width = 4),
               marker = list(color = 'rgba(49,45,129, 1)', size = 12)) %>%
  layout(title = "The number of kills",
         font=list(size = 20),
         margin = m,
         xaxis = list(
           showgrid = FALSE,
           zeroline = FALSE,
           tickfont = list(size = 16)
         ),
         yaxis = list(
           showgrid = FALSE,
           zeroline = TRUE 
         ))
fig
```


```{r corr}

df %>% select(-Movie, -Bond,) %>%
  cor() %>% 
  corrplot()
```

```{r caret}

data(JamesBond)
df <- JamesBond %>% select(-Movie, -US_Gross, -World_Gross, -US_Adj, -Budget, -Avg_User_Rtn_Tom) %>%
  relocate(Avg_User_IMDB, .after = last_col())

train_control <- trainControl(method = "cv", number = 8, savePredictions = "all")

model_rf <- train(Avg_User_IMDB~. , data = df, method = "rf", ntree = 100, trControl = train_control)

explainer_rf <- DALEX::explain(model = model_rf,
                              label = "rf",
                              verbose = FALSE,
                              y = df$Avg_User_IMDB
                              )

print(model_performance(explainer_rf))


plot(model_parts(explainer_rf, loss_function = loss_root_mean_square))
```
```{r breakdown}
no_time_to_die <- data.frame(2021, "Daniel Craig", 608510000, 214930000, 163, 0, 1, 1, 66, 109, 1, 0)
colnames(no_time_to_die) <- colnames(df)
df <- rbind(df, no_time_to_die)

kable(no_time_to_die)

predict(explainer_rf, tail(df, n=1))

pb = predict_parts(explainer = explainer_rf, tail(df, n=1), type= "break_down")
plot(pb)
```

## Resources

James Bond R dataset https://search.r-project.org/CRAN/refmans/HoRM/html/JamesBond.html

Daniel Craig's retrospective https://youtu.be/2oZdJrph3RA

